<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script src="https://apis.google.com/js/client.js?onload=init"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <!--[if IE]>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <![endif]-->
    <title>Anxis Web App</title>
    <!-- CSS  -->
    <link href="../assets/css/bootstrap.css" rel="stylesheet" />
    <link href="../assets/css/anxis.css" rel="stylesheet" />
    <link href="../assets/css/font-awesome.css" rel="stylesheet" />
    <link href="../assets/css/style.css" rel="stylesheet" />
    <link href="../assets/css/morris.css" rel="stylesheet" />
    <link href="../assets/css/bootstrap-dialog.css" rel="stylesheet" />
     <!-- HTML5 Shiv and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <header>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <strong>Email de soporte: </strong>alvarop.garcia@alu.uhu.es
                </div>
            </div>
        </div>
    </header>
    <!-- HEADER END-->
    <div class="navbar navbar-inverse set-radius-zero">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">

                </a>

            </div>

            <div class="left-div">
                <div class="user-settings-wrapper">
                    <ul class="nav">

                        <li class="dropdown">
                            <a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="false">
                                <span class="glyphicon glyphicon-user" style="font-size: 25px;"></span>
                            </a>
                            <div class="dropdown-menu dropdown-settings">
                                <div class="media">
                                    <a class="media-left" href="#">
                                        
                                    </a>
                                    <div class="media-body">
                                        <h4 class="media-heading">Jhon Deo Alex </h4>
                                        <h5>Developer & Designer</h5>

                                    </div>
                                </div>
                                <hr />
                                <h5><strong>Personal Bio : </strong></h5>
                                Anim pariatur cliche reprehen derit.
                                <hr />
                                <a href="#" class="btn btn-info btn-sm">Full Profile</a>&nbsp; <a href="login.html" class="btn btn-danger btn-sm">Logout</a>

                            </div>
                        </li>


                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- LOGO HEADER END-->
    <section class="menu-section">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="navbar-collapse collapse ">
                        <ul id="menu-top" class="nav navbar-nav navbar-right">
                                                        <li><a class="menu-top-active" href="index_medico.html">Inicio</a></li>
                            <li><a href="pacientes_medico.html">Pacientes</a></li>
                            <li><a href="tests_medico.html">Tests</a></li>
                            <li><a href="mensajes_medico.html">Mensajes</a></li>

                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </section>
    <!-- MENU SECTION END-->
    <div class="content-wrapper">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h4 class="page-head-line">Inicio</h4>

                </div>

            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Últimos mensajes recibidos
                        </div>
                        <div class="panel-body" id="mensajes">
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                 <div class="panel panel-default">
                        <div class="panel-heading">
                            Últimos movimientos de los Pacientes
                        </div>
                        <div class="panel-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="tabla_movimientos">
                                    <thead>
                                        <tr>
                                            <th>Paciente</th>
                                            <th>Test</th>
                                            <th>Fecha</th>
                                        </tr>
                                    </thead>
                                    
                                </table>
                            </div>
                        </div>
                    </div>
            </div>

            </div>
                <div class="row">
                <div class="col-md-6">
                <center><div class="caption">Tests realizados por los pacientes:</div></center>
                 <div class="contenedor_grafico" id="donut-example" style="height: 300px;"></div>
            </div>
                    <div class="col-md-6">
                    <center><div class="caption">Valoraciones medias de las encuestas:</div></center>
                 <div class="contenedor_grafico" id="myfirstchart" style="height: 300px;"></div>
            </div>
                    
            </div>
        </div>
    </div>
    <!-- CONTENT-WRAPPER SECTION END-->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    &copy; 2016 Universidad de Huelva
                </div>

            </div>
        </div>
    </footer>
    <!-- FOOTER SECTION END-->
    <!-- JAVASCRIPT AT THE BOTTOM TO REDUCE THE LOADING TIME  -->
    <!-- CORE JQUERY SCRIPTS -->
    <script src="../assets/js/jquery-1.11.1.js"></script>
    
    <!-- SCRIPTS  -->
    <script src="../assets/js/jquery-1.11.1.js"></script>
    <script src="../assets/js/bootstrap.js"></script>
    <script src="../assets/js/raphael.js"></script>
    <script src="../assets/js/morris.min.js"></script>
    <script src="../assets/js/bootstrap-dialog.js"></script>
    
    
    
<script>
var scopes = 'https://www.googleapis.com/auth/userinfo.email';
var client_id = '1019548776931-blbnd36ce3sd81n11di7nqavmsm1skrs.apps.googleusercontent.com';
var mensajes;
var movimientos;
var donut_encuestas;
var barras_tests;
    
        function handleAuth() {
    	  var request = gapi.client.oauth2.userinfo.get().execute(function(resp) {
    	    if (resp.code) {
    	    	window.location.replace("../error.html");
    	    }
    	    else {
      	      
        			/*for (var i=0;i<resp.items.length;i++) {
        				//result = result+ resp.items[i].id_mensaje + "<br/>";
        				
        				
        				result += "<div class='panel-group' id='"+resp.items[i].id_mensaje+"'>";
        				result += "<div class='panel panel-default'>";
        					result += "<div class='panel-heading'>";
        						result += "<h4 class='panel-title'>";
        							result += "<a class='collapsed' href='#collapseOne' data-toggle='collapse' data-parent='#accordion'>"+resp.items[i].nombre_remitente+"</a>";
        								result += "</h4>";
        									result += "</div>";
        										result += "<div class='panel-collapse collapse' id='collapseOne' style='height: 0px;'>";
        											result += "<div class='panel-body'>   <h5>"+resp.items[i].Titulo+"</h5>";
        												result += resp.items[i].id_mensaje;
                                                
        													result += "<br>";
        														result += "<hr>";
                                        
        															result += "<textarea name='"+resp.items[i].id_mensaje+"' class='form-control' placeholder='Descripción' rows='3'></textarea>";
        																result += "<br>";
                                            
        																	//result += "<button id="+resp.items[i].id_mensaje+" onclick='enviarMensaje("+resp.items[i].id_remitente+", "+resp.items[i].Titulo+");' class='btn btn-primary btn-lg' data-toggle='modal' data-target='#myModal'>";
        																	  result += '<button id="+resp.items[i].id_mensaje+" onclick="enviarMensaje(\'' + resp.items[i].id_mensaje + '\', \'' + resp.items[i].id_remitente + '\', \'' + resp.items[i].Titulo + '\');" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">';

        																		result += "Responder <span class='glyphicon glyphicon-send'></span>";
        																			result += " </button>";
        																				result += "</div>";
                                
        																					result += "</div>";
        																						result += "</div>";
        																							result += "</div>";
        				
        				
        				
        			}
        			
        			document.getElementById('mensajes').innerHTML = result;*/

        			
        			var ultimos_movimientos = JSON.parse(sessionStorage.getItem("ultimos_movimientos"));
        			
        			for (var i=0;i<ultimos_movimientos.length;i++) {
        				
        				result += "<tbody>";
            			result += "<tr>";
            			result += "<td>"+ultimos_movimientos[i].nombre_paciente+"</td>";
            			result += "<td>"+ultimos_movimientos[i].nombre_test+"</td>";
            			result += "<td>"+ultimos_movimientos[i].fechaFinalizacion+"</td>";
            			result += "</tr>";
            			result += "</tbody>";
        			}
        			$("#tabla_movimientos").append(result);
					
					
					var result = JSON.parse(sessionStorage.getItem("media_encuestas"));
					
        			new Morris.Bar({
        				  // ID of the element in which to draw the chart.
        				  element: 'myfirstchart',
        				  // Chart data records -- each entry in this array corresponds to a point on
        				  // the chart.
        				  data: [
        				    { Emocion: 'Miedo', Valor: result[0] },
        				    { Emocion: 'Ansiedad', Valor: result[1] },
        				    { Emocion: 'Sensacion Fisica', Valor: result[2] },
        				    { Emocion: 'Confianza', Valor: result[3] },
        				    { Emocion: 'Mejora', Valor: result[4] },
        				    { Emocion: 'General', Valor: result[5] }
        				  ],
        				  // The name of the data record attribute that contains x-values.
        				  xkey: 'Emocion',
        				  // A list of names of data record attributes that contain y-values.
        				  ykeys: ['Valor'],
        				  // Labels for the ykeys -- will be displayed when you hover over the
        				  // chart.
        				  labels: ['Media']
        				});
					
        			var result_donut = JSON.parse(sessionStorage.getItem("test_realizados"));

        			var total = result_donut[0]+result_donut[1]+result_donut[2]+result_donut[3]+result_donut[4];
					Morris.Donut({
					  element: 'donut-example',
					  data: [
					    {label: "Ningun test", value: result_donut[0]},
					    {label: "Entre 1 y 2 tests", value: result_donut[1]},
					    {label: "Entre 3 y 5 tests", value: result_donut[2]},
					    {label: "Entre 6 y 9 tests", value: result_donut[3]},
					    {label: "Diez o mas tests", value: result_donut[4]}
					  ],
					  formatter: function (value, data) { return (value/total *100) + '%'; }
					});

      	      
    	    }
    	  });
    	}
        
        function signin(mode, callback) {
        	  gapi.auth.authorize({client_id: client_id,scope: scopes, immediate: mode},callback);
        }
    
        function init() {
        	var apisToLoad;
        	var callback = function() {
        	   if (--apisToLoad == 0) {
        	     signin(true, handleAuth);
        	   }
        	}
        	  
        	apisToLoad = 2;
        	//Parameters are APIName,APIVersion,CallBack function,API Root 
        	gapi.client.load('anxisendpoint', 'v1', callback, 'http://localhost:8888/_ah/api');
        	//gapi.client.load('anxisendpoint', 'v1', callback, 'https://mybackendapi.appspot.com/_ah/api');
        	gapi.client.load('oauth2','v2',callback);
        }
        
        function enviarMensaje(id_mensaje, id_remitente, titulo) {
        	
        	var mensaje = $('textarea[name='+id_mensaje+']').val();
        	var requestData = {};
        	requestData.titulo = "Re: "+titulo;
        	requestData.mensaje = mensaje;
        	
        	gapi.client.anxisendpoint.sendMensajePacienteMedico({id_paciente: id_remitente}, requestData).execute(function(resp) {

      	    	if (!resp.code) {
      	    		
      	    		setTimeout(function() {
      	    			BootstrapDialog.show({
          	    			title: 'Mensaje enviado',
          	    			message: 'Tu mensaje se ha enviado correctamente!'
          	          });
      	    		}, 3000);
        		}
          	});
        	
        }
        
</script>

<script src="https://apis.google.com/js/client.js?onload=init"></script>
</body>
</html>
